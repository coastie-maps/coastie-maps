<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <script src="https://maps.secondlife.com/_scripts/sl.mapapi2.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maps.secondlife.com/_styles/sl.mapapi2.css">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map-container {
            width: 100%;
            height: 100%;
        }

        #search-container {
            position: absolute;
            z-index: 1000;
            top: 10px;
            left: 80px;
            background: white;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            width: 260px;
            font-family: sans-serif;
            font-size: 14px;
        }

        #searchBox {
            width: 100%;
            padding: 4px;
            margin-bottom: 6px;
            box-sizing: border-box;
        }

        #resultList {
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .resultItem {
            cursor: pointer;
            padding: 2px 0;
        }

        .resultItem:hover {
            background: #eee;
        }

        .debug-point {
            width: 10px;
            height: 10px;
            background: #ff0000;
            border: 2px solid white;
            border-radius: 50%;
        }

        .sector_label {
            font-size: 36px;
            font-weight: bold;
            color: yellow;
            text-shadow:
                -2px -2px 0 black,
                2px -2px 0 black,
                -2px 2px 0 black,
                2px 2px 0 black;
            white-space: nowrap;
        }

        #floatplanner-output {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            padding: 6px 10px;
            font-family: monospace;
            border-radius: 6px;
        }

        .leaflet-tooltip {
            position: absolute;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 650;
            font-family: sans-serif;
            font-size: 12px;
        }

        .leaflet-tooltip:before {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .leaflet-tooltip-top:before {
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
            border-width: 6px 6px 0 6px;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }

        .leaflet-tooltip-bottom:before {
            top: -6px;
            left: 50%;
            margin-left: -6px;
            border-width: 0 6px 6px 6px;
            border-color: transparent transparent rgba(0, 0, 0, 0.8) transparent;
        }

        .leaflet-tooltip-left:before {
            right: -6px;
            top: 50%;
            margin-top: -6px;
            border-width: 6px 0 6px 6px;
            border-color: transparent transparent transparent rgba(0, 0, 0, 0.8);
        }

        .leaflet-tooltip-right:before {
            left: -6px;
            top: 50%;
            margin-top: -6px;
            border-width: 6px 6px 6px 0;
            border-color: transparent rgba(0, 0, 0, 0.8) transparent transparent;
        }

        /*
        .leaflet-marker-icon.marker-selected {
            filter: drop-shadow(0 0 8px yellow);
            transform: scale(1.25);
            z-index: 1000 !important;
        }
        */
        /*
        .leaflet-marker-icon.marker-selected {
            transform: scale(1.5);
            filter: hue-rotate(90deg);
        }
*/
        /*
        .marker-selected img {
            filter: drop-shadow(0 0 8px yellow);
            transform: scale(1.25);
            transition: 0.15s;
        }
*/



        .leaflet-marker-icon.marker-selected {
            /* sicherstellen, dass der Ring sichtbar ist */
            box-shadow: 0 0 0 3px gold, 0 0 10px rgba(255, 215, 0, 0.9);
            border-radius: 999px;
            /* macht den Ring rund/oval */
            z-index: 1000 !important;
            /* nach vorne */
        }

        .resultItem.selected {
            font-weight: bold;
        }
    </style>

    <script>

        var all_markers = [];
        var selected_markers = [];

        var lmap = null;

        var debug_points = [];
        var float_line = null;

        var floatplanner_layer = L.layerGroup();
        var floatplanner_active = false;

        var district_layers = {};
        var layer_control = null;

        var label_markers = [];

        const floatplanner_show_grid = true;
        const floatplanner_step_pixels = 10;
        const label_min_zoom = 0;

        var debug_icon = L.divIcon({
            className: "debug-point",
            iconSize: [10, 10]
        });

        function loadmap() {

            lmap = new SLMap(document.getElementById('map-container'));
            lmap.setView([1012, 1076], 2);

            load_stations();
            load_sectors();

            lmap.on("click", function (e) {
                if (floatplanner_active) {
                    create_debug_point(e.latlng);
                }
            });

            lmap.on("zoomend", refresh_labels);


            document.getElementById("searchBox")
                .addEventListener("input", filter_markers);

            layer_control = L.control.layers(
                null,
                { "Floatplanner": floatplanner_layer }
            ).addTo(lmap);

            lmap.on('overlayadd', function (e) {
                if (e.layer === floatplanner_layer) {
                    floatplanner_active = true;
                }
                refresh_labels();
            });

            lmap.on('overlayremove', function (e) {
                if (e.layer === floatplanner_layer) {
                    floatplanner_active = false;
                    reset_floatplanner();

                }
                refresh_labels();
            });
        }

        function refresh_labels() {
            update_label_visibility();
            update_label_scale();
        }


        function xupdate_label_scale() {
            var zoom = lmap.getZoom();
            var show = zoom >= label_min_zoom;

            label_markers.forEach(m => {
                if (show) {
                    if (!lmap.hasLayer(m)) m.addTo(lmap);
                } else {
                    if (lmap.hasLayer(m)) lmap.removeLayer(m);
                }
            });
        }

        function update_label_visibility() {
            var zoom_ok = lmap.getZoom() >= label_min_zoom;
            label_markers.forEach(m => {

                var district_visible = lmap.hasLayer(m._district_layer);

                if (zoom_ok && district_visible) {

                    if (!m._visible) {
                        m._district_layer.addLayer(m);
                        m._visible = true;
                    }

                } else {

                    if (m._visible) {
                        m._district_layer.removeLayer(m);
                        m._visible = false;
                    }
                }
            });
        }


        function reset_floatplanner() {
            debug_points.forEach(m => floatplanner_layer.removeLayer(m));
            debug_points = [];
            if (float_line) {
                floatplanner_layer.removeLayer(float_line);
                float_line = null;
            }
            document.getElementById("floatplanner-output").textContent = "";
        }

        function load_stations() {

            fetch('stations.json')
                .then(r => r.json())
                .then(stations => {

                    stations.forEach(station => {

                        var icon = L.icon({
                            iconUrl: "marker/" + station.marker,
                            iconSize: [30, 40]
                        });

                        var marker = L.marker(
                            [station.grid_pos[1], station.grid_pos[0]],
                            { icon: icon }
                        ).addTo(lmap);

                        marker.stationData = station;
                        marker._selected = false;
                        marker._mid = "m" + all_markers.length;

                        marker.bindTooltip(
                            station.name,
                            {
                                direction: "top",
                                sticky: true,
                                opacity: 0.95
                            }
                        );

                        // Shift+Klick = markieren
                        marker.on("click", function (e) {

                            if (e.originalEvent.shiftKey) {
                                toggle_marker_selection(marker);
                                return;
                            }

                            lmap.flyTo(marker.getLatLng(), 6);
                        });

                        marker.bindPopup(
                            build_station_popup_html(station, marker)
                        );

                        marker.on("add", function () {
                            apply_marker_selected_style(marker);
                        });

                        marker.on("popupopen", function () {
                            apply_marker_selected_style(marker);
                        });

                        all_markers.push(marker);
                    });

                    update_result_list(all_markers);
                });
        }


        function xload_stations() {
            fetch('stations.json')
                .then(r => r.json())
                .then(stations => {
                    stations.forEach(station => {
                        var icon = L.icon({
                            iconUrl: "marker/" + station.marker,
                            iconSize: [30, 40]
                        });

                        var marker = L.marker(
                            [station.grid_pos[1], station.grid_pos[0]],
                            { icon: icon }
                        ).addTo(lmap);
                        marker.stationData = station;
                        // Hover tooltip (now visible due to CSS patch)
                        marker.bindTooltip(
                            station.name,
                            {
                                direction: "top",
                                sticky: true,
                                opacity: 0.95
                            }
                        );

                        marker.on("click", function () {
                            lmap.flyTo(marker.getLatLng(), 6);
                        });


                        all_markers.push(marker);

                        if (station.url) {
                            marker.bindPopup(
                                "<b>" + station.name + "</b><br>" +
                                "<a href='" + station.url + "' target='_blank'>Teleport</a>"
                            );
                        }
                    });

                    update_result_list(all_markers);
                });
        }

        function xupdate_label_scale() {

            var zoom = lmap.getZoom();

            var size = 14 + (zoom * 2);

            size = Math.max(12, Math.min(size, 40));

            var labels = document.getElementsByClassName("sector_label");

            for (var i = 0; i < labels.length; i++) {
                labels[i].style.fontSize = size + "px";
            }
        }


        function update_label_scale() {

            var zoom = lmap.getZoom();

            var size = 14 + (zoom * 2);
            size = Math.max(12, Math.min(size, 40));

            label_markers.forEach(marker => {
                var el = marker.getElement();
                if (el) {
                    el.style.fontSize = size + "px";
                }
            });
        }


        function load_sectors() {

            fetch('sectors.json')
                .then(r => r.json())
                .then(sectors => {

                    district_layers = {};
                    label_markers = [];

                    sectors.forEach(sec => {

                        if (!district_layers[sec.district]) {
                            district_layers[sec.district] = L.layerGroup().addTo(lmap);
                        }

                        var layer = district_layers[sec.district];

                        var latlngs = sec.coords.map(p => [p[1], p[0]]);
                        var polygon = L.polygon(latlngs, {
                            color: sec.color,
                            weight: 1,
                            fillOpacity: 0
                        });

                        layer.addLayer(polygon);

                        if (sec.labels) {
                            sec.labels.forEach(lbl => {

                                var label_icon = L.divIcon({
                                    className: "sector_label",
                                    html: lbl.text,
                                    iconSize: [0, 0]
                                });

                                var label_marker = L.marker(
                                    [lbl.pos[1], lbl.pos[0]],
                                    { icon: label_icon, draggable: floatplanner_active }
                                );

                                label_marker._visible = true;
                                label_marker._district_layer = layer;
                                layer.addLayer(label_marker);
                                label_markers.push(label_marker);

                            });
                        }

                    });

                    if (layer_control) layer_control.remove();

                    var overlays = {};
                    for (var d in district_layers) {
                        overlays["District " + d] = district_layers[d];
                    }

                    overlays["Floatplanner"] = floatplanner_layer;

                    layer_control = L.control.layers(null, overlays).addTo(lmap);

                    update_label_visibility();
                    update_label_scale();
                });
        }

        /* search */

        function filter_markers() {

            var search = document.getElementById("searchBox").value.toLowerCase().trim();
            var visible = [];

            all_markers.forEach(marker => {

                var name = (marker.stationData.name || "").toLowerCase();
                var region = (marker.stationData.region || "").toLowerCase();

                if (search.length === 0 || name.includes(search) || region.includes(search)) {
                    if (!lmap.hasLayer(marker)) marker.addTo(lmap);
                    visible.push(marker);
                } else {
                    if (lmap.hasLayer(marker)) lmap.removeLayer(marker);
                }
            });

            update_result_list(visible);
        }

        function update_result_list(markers) {

            var list = document.getElementById("resultList");
            var search = document.getElementById("searchBox").value.trim();

            list.innerHTML = "";

            markers = markers.slice().sort((a, b) => {

                var sa = marker_is_selected(a) ? 1 : 0;
                var sb = marker_is_selected(b) ? 1 : 0;

                if (sa !== sb) return sb - sa;

                var an = (a.stationData.name || "").toLowerCase();
                var bn = (b.stationData.name || "").toLowerCase();

                return an.localeCompare(bn);
            });


            if (search.length === 0) {
                list.style.display = "none";
                return;
            }

            list.style.display = "block";

            markers.forEach(marker => {

                var div = document.createElement("div");
                div.className = "resultItem";
                div.textContent = marker.stationData.name;

                div.onclick = function () {
                    lmap.setView(marker.getLatLng(), 6);
                    if (marker.getPopup && marker.getPopup()) marker.openPopup();
                };

                if (marker_is_selected(marker)) {
                    div.classList.add("selected");
                    div.textContent = "â˜… " + div.textContent;
                }


                list.appendChild(div);
            });
        }

        /* Marker Selection */

        function marker_is_selected(marker) {
            return !!marker._selected;
        }

        function apply_marker_selected_style(marker) {
            var el = marker.getElement();
            if (!el) return;

            if (marker._selected)
                el.classList.add("marker-selected");
            else
                el.classList.remove("marker-selected");
        }


        function xapply_marker_selected_style(marker) {
            var el = marker.getElement();
            if (!el) return;

            if (marker._selected) el.classList.add("marker-selected");
            else el.classList.remove("marker-selected");
        }

        function toggle_marker_selection(marker) {

            marker._selected = !marker._selected;

            if (marker._selected) {
                if (!selected_markers.includes(marker))
                    selected_markers.push(marker);
            } else {
                selected_markers =
                    selected_markers.filter(m => m !== marker);
            }

            apply_marker_selected_style(marker);

            var visible = get_current_visible_markers();
            update_result_list(visible);

            if (marker.getPopup()) {
                marker.setPopupContent(
                    build_station_popup_html(marker.stationData, marker)
                );
            }

        }

        function clear_marker_selection() {

            selected_markers.forEach(m => {
                m._selected = false;
                apply_marker_selected_style(m);
            });

            selected_markers = [];

            var visible = get_current_visible_markers();
            update_result_list(visible);
        }

        function get_current_visible_markers() {

            var search = document.getElementById("searchBox")
                .value.toLowerCase().trim();

            if (search.length === 0)
                return all_markers.slice();

            return all_markers.filter(marker => {
                var name = (marker.stationData.name || "")
                    .toLowerCase();
                var region = (marker.stationData.region || "")
                    .toLowerCase();

                return name.includes(search)
                    || region.includes(search);
            });
        }

        function build_station_popup_html(station, marker) {

            var btn_text = marker_is_selected(marker)
                ? "Markierung entfernen"
                : "Markieren";

            var teleport = station.url
                ? "<br><a href='" + station.url +
                "' target='_blank'>Teleport</a>"
                : "";

            return (
                "<b>" + station.name + "</b><br>" +
                "<a href='#' class='js-toggle-select' " +
                "data-marker-id='" + marker._mid + "'>" +
                btn_text + "</a>" +
                teleport
            );
        }


        /* floatplanner */

        function create_debug_point(latlng) {

            var marker = L.marker(latlng, {
                draggable: true,
                icon: debug_icon
            }).addTo(floatplanner_layer);

            if (floatplanner_show_grid) {
                marker.bindTooltip(
                    Math.round(latlng.lng) + " " + Math.round(latlng.lat),
                    { permanent: true }
                );
            }

            marker.on("dragend", update_float_line);

            debug_points.push(marker);
            update_float_line();
        }

        function update_float_line() {

            if (float_line) {
                floatplanner_layer.removeLayer(float_line);
            }

            if (debug_points.length < 2) {
                document.getElementById("floatplanner-output").textContent = "";
                return;
            }

            var latlngs = debug_points.map(m => m.getLatLng());

            float_line = L.polyline(latlngs, {
                color: "#ff0000",
                weight: 2
            }).addTo(floatplanner_layer);

            compute_float_string(latlngs);
        }

        function format_direction_string(str) {

            if (!str || str.length === 0) return "";

            let result = [];
            let current = str[0];
            let count = 1;

            for (let i = 1; i < str.length; i++) {
                if (str[i] === current) {
                    count++;
                } else {
                    result.push(count + current);
                    current = str[i];
                    count = 1;
                }
            }

            result.push(count + current);
            return result.join(" ");
        }

        function export_floatplanner_points() {

            if (debug_points.length === 0) {
                console.log("no points");
                return;
            }

            console.log("---- floatplanner points ----");

            debug_points.forEach(marker => {
                var pos = marker.getLatLng();

                var gx = Math.round(pos.lng);
                var gy = Math.round(pos.lat);

                console.log(gx + " " + gy);
            });

            console.log("END");
        }


        function compute_float_string(latlngs) {

            let result = "";
            let prev_corner = null;

            for (let i = 0; i < latlngs.length - 1; i++) {

                let a = lmap.latLngToContainerPoint(latlngs[i]);
                let b = lmap.latLngToContainerPoint(latlngs[i + 1]);

                let dist = a.distanceTo(b);
                let steps = Math.floor(dist / floatplanner_step_pixels);
                if (steps <= 0) continue;

                for (let s = 0; s <= steps; s++) {

                    let t = s / steps;
                    let px = a.x + (b.x - a.x) * t;
                    let py = a.y + (b.y - a.y) * t;

                    let ll = lmap.containerPointToLatLng([px, py]);

                    let corner = [
                        Math.floor(ll.lng),
                        Math.floor(ll.lat)
                    ];

                    if (!prev_corner) {
                        prev_corner = corner;
                        continue;
                    }

                    if (corner[0] === prev_corner[0] && corner[1] === prev_corner[1]) {
                        continue;
                    }

                    let dx = corner[0] - prev_corner[0];
                    let dy = corner[1] - prev_corner[1];

                    if (dy > 0) result += "N";
                    else if (dy < 0) result += "S";
                    else if (dx > 0) result += "E";
                    else if (dx < 0) result += "W";

                    prev_corner = corner;
                }
            }

            let formatted = format_direction_string(result);
            document.getElementById("floatplanner-output").textContent = formatted;
        }

        document.addEventListener("keydown", function (e) {

            if (e.key === "Escape") {
                document.getElementById("searchBox").value = "";
                document.getElementById("resultList").style.display = "none";
                filter_markers();
            }

            if (e.key === "d" || e.key === "D") {
                if (debug_points.length === 0) return;
                let m = debug_points.pop();
                floatplanner_layer.removeLayer(m);
                update_float_line();
            }

            if (e.key === "e" || e.key === "E") {
                if (floatplanner_active) {
                    export_floatplanner_points();
                }
            }
            if (e.key === "m" || e.key === "M") {

                if (selected_markers.length === 0) return;

                var group = L.featureGroup(selected_markers);
                lmap.fitBounds(group.getBounds());
            }

            if (e.key === "x" || e.key === "X") {
                clear_marker_selection();
            }
        });

        document.addEventListener("click", function (e) {
            var target = e.target;
            if (!target.classList.contains("js-toggle-select"))
                return;
            e.preventDefault();
            var mid = target.getAttribute("data-marker-id");
            var marker = all_markers.find(m => m._mid === mid);
            if (!marker) return;
            toggle_marker_selection(marker);
        });
    </script>
</head>

<body onload="loadmap()">

    <div id="search-container">
        <input type="text" id="searchBox" placeholder="Search...">
        <div id="resultList"></div>
    </div>

    <div id="floatplanner-output"></div>

    <div id="map-container"></div>

</body>

</html>