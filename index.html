<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <script src="https://maps.secondlife.com/_scripts/sl.mapapi2.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maps.secondlife.com/_styles/sl.mapapi2.css">

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        #map-container {
            width: 100%;
            height: 100%;
        }

        #search-container {
            position: absolute;
            z-index: 1000;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            width: 260px;
            font-family: sans-serif;
            font-size: 14px;
        }

        #searchBox {
            width: 100%;
            padding: 4px;
            margin-bottom: 6px;
            box-sizing: border-box;
        }

        #resultCount {
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
        }

        #resultList {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #ddd;
            padding-top: 4px;
        }

        .resultItem {
            cursor: pointer;
            padding: 2px 0;
        }

        .resultItem:hover {
            background: #f0f0f0;
        }
    </style>

    <script>
        var allMarkers = [];
        var lmap = null;

        function loadmap() {
            lmap = new SLMap(document.getElementById('map-container'));
            lmap.setView([1002, 997], 3);

            fetch('stations.json')
                .then(response => response.json())
                .then(stations => {

                    stations.forEach(station => {
                        var icon = L.icon({
                            iconUrl: "marker/" + station.marker,
                            iconSize: [30, 40]
                        });

                        var marker = L.marker(
                            [station.grid_pos[1], station.grid_pos[0]],
                            { icon: icon }
                        ).addTo(lmap);

                        marker.stationData = station;
                        allMarkers.push(marker);

                        marker.bindTooltip(station.name, {
                            permanent: false,
                            direction: "top"
                        });

                        marker.bindPopup(
                            "<b>" + station.name + "</b><br>" +
                            "<a href='" + station.url + "' target='_blank'>Teleport</a>"
                        );
                    });

                    document.getElementById("searchBox")
                        .addEventListener("input", filterMarkers);

                    updateResultList(allMarkers);
                    loadSectors();

                })
                .catch(err => console.error("failed to load resources", err));
        }

        function loadSectors() {
            fetch('sectors.json')
                .then(response => response.json())
                .then(sectors => {
        
                    sectors.forEach(sec => {
        
                        var latlngs = sec.coords.map(p => [p[1], p[0]]);
        
                        var polygon = L.polygon(latlngs, {
                            color: sec.color,
                            fillColor: sec.color,
                            weight: 3,
                            fillOpacity: 0.15
                        }).addTo(lmap);
        
                        polygon.bindTooltip(
                            "District " + sec.district + " - Sector " + sec.sector,
                            { sticky: true }
                        );
                    });
        
                })
                .catch(err => console.error("failed to load sectors", err));
        }


        function filterMarkers() {
            var search = document.getElementById("searchBox").value.toLowerCase();
            var visibleMarkers = [];

            allMarkers.forEach(marker => {
                var name = marker.stationData.name.toLowerCase();
                var region = marker.stationData.region.toLowerCase();

                if (name.includes(search) || region.includes(search)) {
                    marker.addTo(lmap);
                    visibleMarkers.push(marker);
                } else {
                    lmap.removeLayer(marker);
                }
            });

            updateResultList(visibleMarkers);
        }

        function updateResultList(markers) {
            var list = document.getElementById("resultList");
            var count = document.getElementById("resultCount");

            list.innerHTML = "";
            count.textContent = markers.length + " Matches";

            markers.forEach(marker => {
                var div = document.createElement("div");
                div.className = "resultItem";
                div.textContent = marker.stationData.name;

                div.onclick = function() {
                    lmap.setView(marker.getLatLng(), 6);
                    marker.openPopup();
                };

                list.appendChild(div);
            });
        }
    </script>
</head>

<body onload="loadmap()">

    <div id="search-container">
        <input type="text" id="searchBox" placeholder="Search Station and Facilities...">
        <div id="resultCount"></div>
        <div id="resultList"></div>
    </div>

    <div id="map-container"></div>

</body>
</html>

